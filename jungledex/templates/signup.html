<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- jQuery & Tailwind -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <title>정글덱스 | 회원가입</title>
</head>
<body class="flex bg-gray-100 items-center justify-center min-h-screen">

  <!-- 로딩 모달 -->
  <div
    id="loadingModal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
  >
    <div class="bg-white p-6 rounded-lg shadow-lg">
      <p id="loadingTip" class="text-gray-800 text-center">
        <!-- JS에서 순환될 텍스트가 들어갑니다 -->
      </p>
    </div>
  </div>

  <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg">
    <h2 class="text-center text-2xl font-bold mb-6">정글덱스 회원가입</h2>

    <!-- ============= STEP 1: 사용자명 입력 ============= -->
    <form id="step1Form" class="space-y-4">
      <div>
        <label for="username" class="block text-sm font-medium text-gray-900">
          사용자명
        </label>
        <input
          type="text"
          id="username"
          name="username"
          required
          class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
        />
      </div>
      <button
        type="button"
        id="step1Next"
        class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-500"
      >
        다음
      </button>
    </form>

    <!-- STEP 2: 비밀번호 설정 -->
    <form id="step2Form" class="space-y-4 hidden">
      <div>
        <label for="password" class="block text-sm font-medium text-gray-900">비밀번호</label>
        <input
          type="password"
          id="password"
          name="password"
          class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
        />
      </div>
      <div>
        <label for="passwordConfirm" class="block text-sm font-medium text-gray-900">비밀번호 확인</label>
        <input
          type="password"
          id="passwordConfirm"
          name="passwordConfirm"
          class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
        />
      </div>

      <!-- 에러 메시지 영역 -->
      <div id="step2Error" class="hidden text-red-600 text-sm"></div>

      <div class="flex gap-2">
        <button type="button" id="step2Prev" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-200">
          이전
        </button>
        <button type="submit" id="step2Next" class="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-500">
          다음
        </button>
      </div>
    </form>

    <!-- ======== STEP 3: 추가 정보 & 최종 제출 ======== -->
    <form
      id="step3Form"
      class="space-y-4 hidden"
      action="/dashboard"
      method="POST"
    >
      <div>
        <label for="aboutMe" class="block text-sm font-medium text-gray-700">
          한 마디
        </label>
        <textarea
          id="aboutMe"
          name="aboutMe"
          required
          maxlength="50"
          class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
          placeholder="나를 소개할 한마디..."
        ></textarea>
      </div>

      <div>
        <p class="block text-sm font-medium text-gray-700">
          취미 (최소 1개 선택)
        </p>
        <div class="flex flex-wrap gap-2 mt-1">
          <label class="flex items-center space-x-2">
            <input type="checkbox" name="hobby" value="운동" />
            <span>운동</span>
          </label>
          <label class="flex items-center space-x-2">
            <input type="checkbox" name="hobby" value="독서" />
            <span>독서</span>
          </label>
          <label class="flex items-center space-x-2">
            <input type="checkbox" name="hobby" value="음악 감상" />
            <span>음악감상</span>
          </label>
          <label class="flex items-center space-x-2">
            <input type="checkbox" name="hobby" value="여행" />
            <span>여행</span>
          </label>
        </div>
      </div>

      <div>
        <p class="block text-sm font-medium text-gray-700">
          MBTI (4축 모두 선택)
        </p>
        <div class="grid grid-cols-2 gap-4 mt-1 text-sm">
          <!-- 외향/내향 -->
          <div>
            <p class="text-xs text-gray-600 mb-1">외향/내향</p>
            <label class="inline-flex items-center space-x-1"><input type="radio" name="ei" value="E" /><span>E</span></label>
            <label class="inline-flex items-center space-x-1"><input type="radio" name="ei" value="I" /><span>I</span></label>
          </div>
          <!-- 감각/직관 -->
          <div>
            <p class="text-xs text-gray-600 mb-1">감각/직관</p>
            <label class="inline-flex items-center space-x-1"><input type="radio" name="sn" value="S" /><span>S</span></label>
            <label class="inline-flex items-center space-x-1"><input type="radio" name="sn" value="N" /><span>N</span></label>
          </div>
          <!-- 사고/감정 -->
          <div>
            <p class="text-xs text-gray-600 mb-1">사고/감정</p>
            <label class="inline-flex items-center space-x-1"><input type="radio" name="tf" value="T" /><span>T</span></label>
            <label class="inline-flex items-center space-x-1"><input type="radio" name="tf" value="F" /><span>F</span></label>
          </div>
          <!-- 판단/인식 -->
          <div>
            <p class="text-xs text-gray-600 mb-1">판단/인식</p>
            <label class="inline-flex items-center space-x-1"><input type="radio" name="jp" value="J" /><span>J</span></label>
            <label class="inline-flex items-center space-x-1"><input type="radio" name="jp" value="P" /><span>P</span></label>
          </div>
        </div>
      </div>

      <div>
        <label for="languages" class="block text-sm font-medium text-gray-700">선호 언어</label>
        <select
          id="languages"
          name="languages"
          required
          class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
        >
          <option value="">선택해주세요</option>
          <option>Python</option>
          <option>JavaScript</option>
          <option>Java</option>
          <option>C++</option>
          <option>Go</option>
          <option>Rust</option>
          <option>TypeScript</option>
          <option>Swift</option>
          <option>Kotlin</option>
        </select>
      </div>

      <div>
        <label for="about" class="block text-sm font-medium text-gray-700">추가로 하고 싶은 말</label>
        <textarea
          id="about"
          name="about"
          placeholder="추가로 하고 싶은 말"
          class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
        ></textarea>
      </div>

      <div class="flex gap-2">
        <button type="button" id="step3Prev" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-200">이전</button>
        <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-500">완료</button>
      </div>
    </form>

    <p class="mt-6 text-center">
      <a href="/signin" class="text-indigo-600 hover:underline">로그인 화면으로 돌아가기</a>
    </p>
  </div>

  <script>

    $(function() {
      // ------------------------------
      // 로딩 모달 & 팁 순환 함수 정의
      // ------------------------------
      const loadingTips = [
        "Tip: 정글에서 살아남기 위해 여러 정글러들을 만나보세요",
        "Tip: 정글몬이 불쑥 튀어나와도 놀라지 마세요",
        "Tip: 정글 도감을 인쇄하는 중...",
        "Tip: 주기적으로 정글을 탐험해보세요"
      ];
      let tipIndex = 0, tipInterval;

      function showLoading() {
        $('#loadingTip').text(loadingTips[tipIndex]);
        tipIndex = (tipIndex + 1) % loadingTips.length;
        $('#loadingModal').removeClass('hidden');
        tipInterval = setInterval(() => {
          $('#loadingTip').text(loadingTips[tipIndex]);
          tipIndex = (tipIndex + 1) % loadingTips.length;
        }, 3000);
      }

      function hideLoading() {
        clearInterval(tipInterval);
        $('#loadingModal').addClass('hidden');
      }
      // ------------------------------

      // ------------------------------
      // 1) 초기화: step1만 보이기 & 포커스
      // ------------------------------
      showStep(1);

      // ------------------------------
      // 2) showStep 함수
      // ------------------------------
      function showStep(n) {
        $('#step1Form, #step2Form, #step3Form').hide();
        $(`#step${n}Form`).show();

        if (n === 1) {
          $('#username').focus();
        } else if (n === 2) {
          $('#password').focus();
        } else if (n === 3) {
          $('#aboutMe').focus();
        }
      }

      // STEP1: Enter/Click
      $('#step1Form').on('submit', function(e) {
        e.preventDefault(); handleStep1Next();
      });
      $('#step1Next').on('click', handleStep1Next);

      function handleStep1Next() {
        const username = $('#username').val().trim();
        if (!username) { alert('사용자명을 입력해주세요.'); $('#username').focus(); return; }
        $.ajax({
          url: '/api/auth/check', method: 'POST', contentType: 'application/json; charset=UTF-8',
          data: JSON.stringify({ username }), dataType: 'json',
          success() { showStep(2); }, error(xhr) { if (xhr.status===409) alert('이미 사용 중인 사용자명입니다.'); else alert('서버 오류'); }
        });
      }

      // STEP2: 이전/다음/Enter
      $('#step2Prev').on('click', () => showStep(1));
      function handleStep2Next() {
        const pw  = $('#password').val(), pwc = $('#passwordConfirm').val();
        $('#step2Error').hide().text('');
        if (!pw||!pwc) { $('#step2Error').text('비밀번호와 확인을 모두 입력해주세요.').show(); return; }
        if (pw!==pwc) { $('#step2Error').text('비밀번호가 일치하지 않습니다.').show(); return; }
        showStep(3);
      }
      $('#password, #passwordConfirm').on('input', () => { $('#step2Error').hide().text(''); });
      $('#step2Next').on('click', handleStep2Next);
      $('#step2Form').on('submit', function(e) { e.preventDefault(); handleStep2Next(); });

      // STEP3: 이전
      $('#step3Prev').on('click', () => showStep(2));

      // STEP3: AJAX로 회원가입 요청
      $('#step3Form').on('submit', function(e) {
        e.preventDefault();
        const username = $('#username').val().trim();
        const password = $('#password').val();
        const aboutMe  = $('#aboutMe').val().trim();
        const hobbies  = $('input[name="hobby"]:checked').map(function() { return this.value; }).get();
        const mbti     = ['ei','sn','tf','jp'].map(key => $(`input[name="${key}"]:checked`).val()).join('');
        const languages= $('#languages').val();
        const about    = $('#about').val().trim();

        // 로딩 모달 표시
        showLoading();

        $.ajax({
          url: '/api/auth/signup', method: 'POST', contentType: 'application/json; charset=UTF-8',
          data: JSON.stringify({ username, password, aboutMe, hobbies, mbti, languages, about }), dataType: 'json',
          success(res) {
            // 완료 후 대시보드로 이동
            window.location.href = '/dashboard';
          },
          error(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.message || '서버 오류가 발생했습니다.';
            alert('회원가입 실패: ' + msg);
          }
        });
      });
    });
  </script>
</body>
</html>